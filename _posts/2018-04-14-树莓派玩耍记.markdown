---
layout:     post
title:      "æ ‘èŽ“æ´¾çŽ©è€è®°"
subtitle:   "å®‰è£…,é…ç½®raspberry piä»¥åŠå¼€å‘ç®€å•åº”ç”¨"
date:       2018-04-14 21:52:41
author:     "Lestat"
header-img: "img/post-bg-2015.jpg"
catalog: true
tags:
    - æ ‘èŽ“æ´¾
    - linux
---

> è¿™ç¯‡æ–‡ç« æ˜¯è‡ªå·±å…¥æ‰‹æ ‘èŽ“æ´¾ä¹‹åŽçš„ä¸€äº›ä½¿ç”¨è®°å½•  
> å‰äº›å¤©çœ‹ v2ex ä¸Šæœ‰äººè®¨è®ºæ ‘èŽ“æ´¾ï¼ŒäºŽæ˜¯å‡ºäºŽå¥½å¥‡åœ¨æ·˜å®ä¸Šæ·˜äº†ä¸€åªæ ‘èŽ“æ´¾æ¥çŽ©çŽ©

ä½“ç§¯è¶…çº§å°...  
![](https://lestat.b0.upaiyun.com/blog/20180414/211523716251_.pic_hd.jpg)

ä¸€ä¸ªæ¿å­,ä¸€ä¸ªå¡‘æ–™ç›’å­è£…ä¸Šå®Œå·¥
![](https://lestat.b0.upaiyun.com/blog/20180414/201523716248_.pic_hd.jpg)

åˆšå¼€å§‹çš„æ—¶å€™å°è¯•äº†ä¸€ä¸‹å®˜æ–¹çš„[NOOBS](https://www.raspberrypi.org/downloads/noobs/)å·¥å…·å®‰è£…[raspbian](https://www.raspberrypi.org/downloads/raspbian/)ç³»ç»Ÿ,è¿™ä¸ªç³»ç»Ÿæ˜¯ä¸ºæ ‘èŽ“æ´¾å®šåˆ¶çš„åŸºäºŽ[Debian](https://zh.wikipedia.org/wiki/Debian)çš„ linux ç³»ç»Ÿ,ä½†ä¸çŸ¥ä»€ä¹ˆåŽŸå› æ€»æ˜¯é—´æ­‡æ€§å¡æ­»,åŠ ä¹‹ä¸ªäººåå¥½ ubuntu ä¸€ç‚¹,äºŽæ˜¯å®‰è£…äº†[Ubuntu_MATE](https://zh.wikipedia.org/wiki/Ubuntu_MATE)

### ç³»ç»Ÿå®‰è£…åŸºæœ¬æ­¥éª¤:

1.  ä¸‹è½½[ç³»ç»Ÿé•œåƒ](https://ubuntu-mate.org/download/)
2.  å°†ä¸‹è½½çš„`ubuntu-mate-16.04.2-desktop-armhf-raspberry-pi.img`é•œåƒè§£åŽ‹åŽä½¿ç”¨`dd`å‘½ä»¤å°†é•œåƒå†™å…¥åˆ° sd å¡ä¸­(æˆ‘çš„çŽ¯å¢ƒä¸º macOS),æ³¨æ„å†™å…¥å®ŒæˆåŽä¸€å®šè¦ä½¿ç”¨`unmount`å°† sd å¡æŽ¨å‡º,ç„¶åŽæ‹”å‡º sd å¡
3.  å°† sd å¡æ’å…¥æ ‘èŽ“æ´¾,å¹¶è¿žæŽ¥å¥½æ‰€æœ‰å¤–è®¾åŽå¼€æœº,ç„¶åŽåƒå®‰è£… QQ ä¸€æ ·å®Œæˆäº†[Ubuntu_MATE](https://zh.wikipedia.org/wiki/Ubuntu_MATE)çš„å®‰è£…è¿‡ç¨‹

### ç®€æ˜“æ’­æŠ¥ç³»ç»Ÿ:

> å½“æ—¶å†’å‡ºä¸€ä¸ªæƒ³æ³•:å†™ä¸€ä¸ªæ¯å¤©å®šæ—¶æ’­æ”¾æœªæ¥ä¸¤å¤©å¤©æ°”é¢„æŠ¥çš„å°ç¨‹åº(éžå½¼å°ç¨‹åº),æ¶‰åŠçš„åŠŸèƒ½ç‚¹:å¤©æ°”é¢„æŠ¥æŽ¥å£;ä¸€ä¸ªåŸºäºŽè½»é‡çº§çš„ api æ¡†æž¶å®žçŽ°çš„ api;ä¸€ä¸ªå®šæ—¶ä»»åŠ¡;ä¸€ä¸ªæ–‡å­—è½¬è¯­éŸ³è„šæœ¬;ä¸€ä¸ªéŸ³é¢‘æ–‡ä»¶æ’­æ”¾å™¨;å½“ç„¶è¿˜éœ€è¦ä¸€ä¸ªå¤–æŽ¥å°éŸ³ç®±...

äºŽæ˜¯å®‰è£…äº† lnmp çŽ¯å¢ƒ(å½“ä¸‹æ²¡æœ‰ç”¨åˆ° mysql),mplayer,git,æ–‡å­—è½¬éŸ³é¢‘ä½¿ç”¨çš„ç™¾åº¦[sdk(php)](http://bos.nj.bpc.baidu.com/v1/audio/aip-speech-php-sdk-1.6.0.zip),é€šè¿‡ git å®‰è£…äº†[lumen](https://lumen.laravel.com/)

#### æŽ¥å£å¼€å‘

1.  è·¯ç”±

```php
$router->get('/get_weather','WeatherController@getWeather');
```

2.  æŽ§åˆ¶å™¨`WeatherController.php`

```php
<?php

namespace App\Http\Controllers;

use GuzzleHttp\Client;
use Illuminate\Support\Facades\Cache;

class WeatherController extends Controller
{
    /**
     * Create a new controller instance.
     *
     * @return void
     */
    public function __construct()
    {
        //
    }

    //åŸºäºŽæ ‘èŽ“æ´¾çš„ç®€æ˜“å¤©æ°”é¢„æŠ¥ç³»ç»Ÿ
    public function getWeather()
    {
        //èŽ·å–å¤©æ°”ä¿¡æ¯
        $client = new Client();  // å®žä¾‹åŒ–
        $city = 'æˆéƒ½';
        $city_code = urlencode($city);
        $aqi = [
            'å¥½',
            'ä¸­ç­‰',
            'ä¸é€‚äºŽæ•æ„Ÿäººç¾¤',
            'ä¸å¥åº·',
            'éžå¸¸ä¸å¥åº·',
            'å±é™©',
        ];

        if (Cache::has('report') === false) {
            $url = 'https://www.sojson.com/open/api/weather/json.shtml?city=' . $city_code;    // è®¾ç½®ä¸€ä¸ªå¯è®¿é—®çš„ url
            $http = $client->request('GET', $url);  // æ‰§è¡Œ

            // åˆ¤æ–­ http çŠ¶æ€ç ä¸º 200 çš„æ—¶å€™ï¼Œæ‰§è¡ŒæˆåŠŸ
            $aqi_content = 'æœªçŸ¥';
            if ($http->getStatusCode() == 200) {
                $weather = json_decode($http->getBody()->getContents(), true);
                if ($weather['data']['forecast'][0]['aqi'] <= 50) {
                    $aqi_content = $aqi[0];
                } else if ($weather['data']['forecast'][0]['aqi'] <= 100) {
                    $aqi_content = $aqi[1];
                } else if ($weather['data']['forecast'][0]['aqi'] <= 150) {
                    $aqi_content = $aqi[2];
                } else if ($weather['data']['forecast'][0]['aqi'] <= 200) {
                    $aqi_content = $aqi[3];
                } else if ($weather['data']['forecast'][0]['aqi'] <= 300) {
                    $aqi_content = $aqi[4];
                } else if ($weather['data']['forecast'][0]['aqi'] <= 500) {
                    $aqi_content = $aqi[5];
                } else {

                }
                //æ‹¼è£…å­—ç¬¦ä¸²
                $report = 'çŽ°åœ¨é¢„æŠ¥,' . $city . 'æœªæ¥ä¸¤å¤©å¤©æ°”æƒ…å†µ,' . $city . ',' . date('Yå¹´mæœˆ', time()) . $weather['data']['forecast'][1]['date'] . ',å¤©æ°”æƒ…å†µ,' . $weather['data']['forecast'][1]['high'] . ',' . $weather['data']['forecast'][1]['low'] . ',' . $weather['data']['forecast'][1]['type'] . ',' . $weather['data']['forecast'][1]['fx'] . ',é£ŽåŠ›,' . $weather['data']['forecast'][1]['fl'] . ',æ—¥å‡ºæ—¶é—´,' . $weather['data']['forecast'][1]['sunrise'] . ',æ—¥è½æ—¶é—´,' . $weather['data']['forecast'][1]['sunset'] . ',ç©ºæ°”æ±¡æŸ“æŒ‡æ•°,' . $aqi_content;
                $report .= ',' . $city . ',' . date('Yå¹´mæœˆ', time()) . $weather['data']['forecast'][2]['date'] . ',å¤©æ°”æƒ…å†µ,' . $weather['data']['forecast'][2]['high'] . ',' . $weather['data']['forecast'][2]['low'] . ',' . $weather['data']['forecast'][2]['type'] . ',' . $weather['data']['forecast'][2]['fx'] . ',é£ŽåŠ›,' . $weather['data']['forecast'][2]['fl'] . ',æ—¥å‡ºæ—¶é—´,' . $weather['data']['forecast'][2]['sunrise'] . ',æ—¥è½æ—¶é—´,' . $weather['data']['forecast'][2]['sunset'] . ',ç©ºæ°”æ±¡æŸ“æŒ‡æ•°,' . $aqi_content;
                Cache::add('report', $report, 60);
            }
        }
        $report = Cache::get('report');
        generate_audio($report);
    }
}
```
ä»¥ä¸Šçš„`generate_audio()`å³æ˜¯è‡ªè¡Œå°è£…åŽçš„ç™¾åº¦çš„æ–‡å­—è½¬è¯­éŸ³sdk
#### å®šæ—¶ä»»åŠ¡
1. åˆ›å»ºä¸€ä¸ªç›®å½•`/data/weather_reports/`ç”¨äºŽä¿å­˜mp3ä¸´æ—¶æ–‡ä»¶
2. `crontab -e`æ·»åŠ å®šæ—¶ä»»åŠ¡
```shell
30 19 * * * curl http://localhost/get_weather && /usr/bin/mplayer /data/weather_reports/weather_forecast.mp3 > /dev/null 2>&1
```
ä»¥ä¸Šæ˜¯æ¯å¤©19ç‚¹30åˆ†ä½¿ç”¨`curl`å‘½ä»¤è¯·æ±‚æœ¬åœ°çš„apiå¹¶ä½¿ç”¨`mplayer`æ‰“å¼€ä½äºŽ`/data/weather_reports/`ç›®å½•çš„`weather_forecast.mp3`æ–‡ä»¶,å¹¶å°†æ ‡å‡†è¾“å‡º&é”™è¯¯è¾“å‡ºé‡å®šå‘åˆ°ç©ºæ–‡ä»¶ä¸­

### ç®€æ˜“æ’­æŠ¥ç³»ç»Ÿå®Œæˆ
è‡³æ­¤,ä¸€ä¸ªå®šæ—¶æ’­æŠ¥å°ç¨‹åºå·²å®Œæˆ,åŒæ—¶è¿˜å¯ä»¥åˆ©ç”¨[å†…ç½‘ç©¿é€](https://lestatmiao.github.io/2018/03/26/frp+nginx%E5%AE%9E%E7%8E%B0%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F/)å¼€æ”¾å…¬ç½‘å¯¹è¯¥æ ‘èŽ“æ´¾çš„sshè®¿é—®,å®žçŽ°è¿œç¨‹é¥æŽ§æ’­æ”¾ðŸ˜‹  
ä¸ºäº†è¿›ä¸€æ­¥æ–¹ä¾¿æ“ä½œ(å› ä¸ºé™¤äº†ç¬¬ä¸€æ¬¡å®‰è£…ç³»ç»Ÿ,å…¶ä»–æ—¶å€™éƒ½å¸Œæœ›ç›´æŽ¥é€šè¿‡å‘½ä»¤è¡Œæ“ä½œæ ‘èŽ“æ´¾è€Œä¸æ˜¯å¤–æŽ¥ä¸€ä¸ªæ˜¾ç¤ºå™¨,èµ„æºæœ‰é™...),å°†frpå®¢æˆ·ç«¯çš„è¿žæŽ¥å‘½ä»¤åŠ å…¥äº†å¼€æœºå¯åŠ¨  

### å¼€æœºå¯åŠ¨æ­¥éª¤
1. åœ¨`frp`å®¢æˆ·ç«¯æ‰€åœ¨ç›®å½•æ–°å»ºshæ–‡ä»¶`frp_start.sh`æ–‡ä»¶,å¹¶èµ‹äºˆæ‰§è¡Œæƒé™
```
touch ./frp_start.sh
chmod +x ./frp_start.sh
```
2. å†™å…¥å‘½ä»¤
```
#!/bin/bash
### BEGIN INIT INFO
# Provides:          lestat
# Required-Start:    $local_fs $network
# Required-Stop:     $local_fs
# Default-Start:     2 3 4 5
# Default-Stop:      0 1 6
# Short-Description: start frp service
# Description:       start frp service
### END INIT INFO
cd frpå®¢æˆ·ç«¯æ‰€åœ¨ç›®å½•
nohup ./frpc -c ./frpc.ini &
```
3. å°†æ–‡ä»¶è¿žæŽ¥åˆ°`/etc/init.d/`ç›®å½•
```
ln -s frpå®¢æˆ·ç«¯æ‰€åœ¨ç›®å½•/frp_start.sh /etc/init.d/frp_start
```
4. åœ¨`/etc/init.d/`ä½¿ç”¨`update-rc.d`å‘½ä»¤è¿›è¡Œé…ç½®
```
sudo update-rc.d frp_start defaults 99
```
5. é…ç½®æˆåŠŸåŽå¯ä»¥åœ¨`/etc/rc[å¯¹åº”çš„ç³»ç»Ÿè¿è¡Œçº§åˆ«].d/`ç›®å½•ä¸­çœ‹åˆ°`frp_start`


>**æœªå®Œå¾…ç»­...**