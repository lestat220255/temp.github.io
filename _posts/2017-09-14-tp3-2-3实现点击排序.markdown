---
layout:     post
title:      "tp3.2.3å®ç°æ”¯æŒç‚¹å‡»æ’åº"
subtitle:   "\"é’ˆå¯¹å…¬å¸åå°ç®¡ç†ç³»ç»Ÿå†™çš„åˆ—è¡¨ç‚¹å‡»æ’åº\""
date:       2017-09-14 10:28:05
author:     "Lestat"
header-img: "img/post-bg-2015.jpg"
catalog: true
tags:
    - thinkphp
---


> å‡è®¾:
* `Admin/Home/Controller/BaseController.class.php`æ˜¯ä¸€ä¸ªåŸºç¡€æ§åˆ¶å™¨
* `$current_params`å’Œ`$in`æ˜¯ä¸¤ä¸ªåœ¨`Admin/Home/Controller/BaseController.class.php`ä¸­ç”¨æ¥ä¿å­˜æ¥æ”¶å‚æ•°çš„å±æ€§,å¹¶ä¸”å·²ç»åœ¨æ„é€ å‡½æ•°ä¸­å¯¹å…¶èµ‹å€¼
* `Admin/Tpl/Index/footer.html`æ˜¯å¸ƒå±€ä¸­çš„å…¬å…±éƒ¨åˆ†
* `Public/Model/BaseModel.class.php`æ˜¯å…¬å…±æ¨¡å‹
* è¯·æ±‚ä¸­ç”¨æ¥è¡¨ç¤º`æ¨¡å—`,`æ§åˆ¶å™¨`,`æ“ä½œ`çš„å‚æ•°åç§°åˆ†åˆ«ä¸º:`m`,`c`,`a`
* `#searchForm`å’Œ`#excelForm`åˆ†åˆ«ä¸ºæ¡ä»¶æœç´¢formå’Œexcelè¡¨å•å¯¼å‡ºè¯·æ±‚æäº¤æ—¶ç”¨æ¥ä¸´æ—¶ä¿å­˜å’Œä¼ é€’ç­›é€‰æ¡ä»¶çš„form

## å…¨å±€æ”¹åŠ¨
### `Admin/Home/Controller/BaseController.class.php`æ”¹åŠ¨:  
æ–°å¢`protected $current_params`å±æ€§  
`_initialize`æ–¹æ³•å°¾éƒ¨æ–°å¢ä»¥ä¸‹ä»£ç (ç”¨äºå¤„ç†ä¼ å…¥çš„æœ‰æ•ˆå‚æ•°):  
```php
unset($this->current_params['m']);
unset($this->current_params['c']);
unset($this->current_params['a']);
$this->assign('page_url', U(CONTROLLER_NAME.'/'.ACTION_NAME,$this->current_params));
```


æ§åˆ¶å™¨å°¾éƒ¨æ–°å¢ä»¥ä¸‹æ–¹æ³•:  
```php
/*
 * todo:å¤„ç†æ’åºè¯·æ±‚
 * @param $sort string ç”¨æ¥mysqlæ’åºçš„å­—ç¬¦ä¸²
 * @param $column string ç”¨æ¥æŒ‡å®šæ’åºå­—æ®µåç§°
 * @param $value int æ’åºå€¼,1:é¡ºåº;2:å€’åº
 * @param $table string éœ€è¦æ’åºå­—æ®µåœ¨å½“å‰sqlè¯­å¥ä¸­è¡¨çš„åˆ«å
 * @return string è¿”å›å¤„ç†åçš„$order
 * */
protected function assembleSort($sort,$column,$value,$table){
    $order = urldecode($sort);
    $v_sort[$column] = $value == 1 ? 2 : 1;
    $v_sort['param_sort'] = $sort;
    $v_sort['param_column'] = $column;
    $v_sort['param_value'] = $v_sort[$column];
    $v_sort['param_table'] = $table;
    $this->assign('sort', $v_sort);
    return $order;
}
```

### `Admin/Tpl/Index/footer.html`æ”¹åŠ¨:  
åœ¨`</body>`æ ‡ç­¾å‰æ–°å¢ä»¥ä¸‹ä»£ç :  
html(ä¿å­˜å½“å‰é¡µé¢å¹¶æºå¸¦é™¤æ’åºç›¸å…³å‚æ•°çš„url):  
```html
<input type="hidden" id="page_url" value="{{$page_url}}">
```
js:  
```javascript
/*
    * todo:å…¨å±€ç›‘å¬å¹¶å¤„ç†ç‚¹å‡»æ’åºæ“ä½œ
    * */
    $(function(){
        var form = $('#searchForm');
        if(typeof(form) !== 'undefined'){
            form.append("<input class='excel' type='hidden' name='sort' value='{{$sort.param_sort}}'/><input class='excel' type='hidden' name='column' value='{{$sort.param_column}}'/><input class='excel' type='hidden' name='value' value='{{$sort.param_value}}'/><input class='excel' type='hidden' name='table' value='{{$sort.param_table}}'/>");
        }
        $('th[data-sort=1]').attr('class','sortable').append('ğŸ”»');
        $('th[data-sort=2]').attr('class','sortable').append('ğŸ”º');
        $('tr').delegate('th','click',function(){
            var sort = $(this).attr('data-sort');
            var param = ``;
            if(typeof(sort) !== 'undefined'){
                var order = ``;
                var column = $(this).attr('data-column');
                var table = $(this).attr('data-table') ? $(this).attr('data-table') + '.' : '';
                if(sort == 1){
                    order = 'asc'
                }else if(sort == 2){
                    order = 'desc';
                }
                param = `${table}${column} ${order}`;
                var url = $('#page_url').val() + '&sort=' + param + '&column=' + column + '&value=' + sort + '&table=' + table;
                location.href = url;
            }
        });
    });
    /*
    * todo:å¤„ç†å¯¼å‡ºexcelæ“ä½œ
    * */
    if(typeof($('#excel')) !== 'undefined'){
        $('#excel').click(function () {
            ui.confirm('ç¡®å®šå¯¼å‡ºå—', function () {
                var eform = $('#excelform');
                if ($('#data').find('tr').length < 2) {
                    ui.error('æ²¡æœ‰å¯ä»¥å¯¼å‡ºçš„æ•°æ®');
                    return false;
                }
                eform.html($('.excel').clone());
                eform.submit();
            });
        });
    }
```
### `Public/Model/BaseModel.class.php`æ”¹åŠ¨:
ä¿®æ”¹`getPage`å’Œ`getExcel`æ–¹æ³•å¦‚ä¸‹:  
```php
/**
 * todo:è·å–åˆ—è¡¨è®°å½•å¹¶è¿”å›åˆ†é¡µæ•°æ®
 * @param $map array ç­›é€‰æ¡ä»¶
 * @param $order string æ’åºè§„åˆ™
 */
public function getPage($map, $order = '')
{
    $count = $this->where($map)->count();
    $page = classPage($count);
    $row['info'] = $this->where($map)->order($order)->limit($page->firstRow, $page->listRows)->select();
    $row['page'] = $page->show();
    return $row;
}

/**
 * todo:è·å–å¯¼å‡ºåˆ°excelçš„æ•°æ®é›†åˆ
 * @param $map array ç­›é€‰æ¡ä»¶
 * @param $order string æ’åºè§„åˆ™
 */
public function getExcel($map,$order = '')
{
    $data = $this->where($map)->order($order)->select();
    return $data;
}
```
### `Admin/root/static/css/shop_manager.css`æ”¹åŠ¨:  
åœ¨å°¾éƒ¨æ–°å¢(ç”¨äºæ§åˆ¶å¯ç‚¹å‡»`th`æ ·å¼):  
```css
.sortable{
    cursor: pointer;
    color:orangered;
}
```

---
## å±€éƒ¨æ”¹åŠ¨
### controller  
åœ¨ç›¸å…³controllerä¸­çš„åˆ—è¡¨æ–¹æ³•(é€šå¸¸æ˜¯index)ä¸­,æ–°å¢ä¸€è¡Œ:  
```php
$order = $this->assembleSort($this->in['sort'], $this->in['column'], $this->in['value'], $this->in['table']);
```
å¹¶å°†ä¹‹å‰  
```php
$data = $model->getPage($where);
```
æ”¹ä¸º:  
```php
$data = $model->getPage($where, $order);
```
åœ¨ç›¸å…³æ§åˆ¶å™¨ä¸­çš„å¯¼å‡ºåˆ°excelæ–¹æ³•(é€šå¸¸æ˜¯excel)ä¸­,åšä¸Šè¿°ç›¸åŒå¤„ç†  

### view
åœ¨ç›¸å…³viewä¸­,ä¿®æ”¹éœ€è¦æ’åºçš„å­—æ®µçš„`th`æ ‡ç­¾å¦‚ä¸‹:  
```html
<th width="180px" data-sort="{{$sort.create_time|default=1}}" data-column="create_time" data-table="A">æ·»åŠ æ—¶é—´</th>
```
> å‚æ•°å¤‡æ³¨:  

```html
<th width="180px" data-sort="{{$sort.éœ€è¦æ’åºçš„å­—æ®µåç§°|default=é»˜è®¤å€¼1:å½“å‰ä¸ºå€’åº,2:å½“å‰ä¸ºé¡ºåº}}" data-column="éœ€è¦æ’åºçš„å­—æ®µåç§°" data-table="å¦‚æœå½“å‰åˆ—è¡¨éœ€è¦é€šè¿‡joinæŸ¥è¯¢,æ­¤å¤„ä¸ºè¯¥å­—æ®µæ‰€å±çš„è¡¨åˆ«å">æ·»åŠ æ—¶é—´</th>
```

> å…¶å®ƒå¤‡æ³¨:
* å¦‚æœå½“å‰é¡µé¢éœ€è¦æ¥æ”¶å‚æ•°,å¦‚:é…é€ç‚¹ä¸‹é¢çš„é…é€å…ƒå‘˜åˆ—è¡¨,åˆ™éœ€è¦åœ¨`#searchForm`çš„`form`ä¸­æ–°å¢ä¸€ä¸ª`input`æ ‡ç­¾:`<input type="hidden" class="excel" name="point_id(å‚æ•°åç§°)" value="{{$point.id}}(å‚æ•°å€¼)">`  
* åœ¨æ‰€æœ‰é‡å†™äº†`BaseModel`çš„`getPage`æˆ–`getExcel`æ–¹æ³•çš„æ¨¡å‹ä¸­éƒ½éœ€è¦åšç›¸åº”ä¿®æ”¹
